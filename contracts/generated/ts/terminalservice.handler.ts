// Code generated by dink codegen. DO NOT EDIT.

import type { ServiceHandler, ServiceDefinition } from '@fatagnus/dink-sdk';
import { extractPayload, wrapResponse } from '@fatagnus/dink-sdk';
import type { OpenRequest, OpenResponse, InputRequest, InputResponse, ResizeRequest, ResizeResponse, StreamOutputRequest, StreamOutputResponse } from './types.js';

export interface TerminalServiceServer {
  Open(req: OpenRequest): Promise<OpenResponse>;
  Input(req: InputRequest): Promise<InputResponse>;
  Resize(req: ResizeRequest): Promise<ResizeResponse>;
  StreamOutput(req: StreamOutputRequest, stream: { send: (msg: StreamOutputResponse) => Promise<void> }): Promise<void>;
}

export class TerminalServiceHandler implements ServiceHandler {
  private impl: TerminalServiceServer;

  constructor(impl: TerminalServiceServer) {
    this.impl = impl;
  }

  definition(): ServiceDefinition {
    return {
      name: 'TerminalService',
      version: '1.0.0',
      methods: [
        'Open',
        'Input',
        'Resize',
        'StreamOutput',
      ],
    };
  }

  async handleRequest(method: string, data: Uint8Array): Promise<Uint8Array> {
    const decoder = new TextDecoder();
    const encoder = new TextEncoder();
    const rawReq = data.length > 0 ? JSON.parse(decoder.decode(data)) : {};

    switch (method) {
    case 'Open': {
      const req = extractPayload<OpenRequest>(rawReq);
      const resp = await this.impl.Open(req);
      return encoder.encode(JSON.stringify(wrapResponse(resp)));
    }
    case 'Input': {
      const req = extractPayload<InputRequest>(rawReq);
      const resp = await this.impl.Input(req);
      return encoder.encode(JSON.stringify(wrapResponse(resp)));
    }
    case 'Resize': {
      const req = extractPayload<ResizeRequest>(rawReq);
      const resp = await this.impl.Resize(req);
      return encoder.encode(JSON.stringify(wrapResponse(resp)));
    }
    default:
      throw new Error(`Unknown method: ${method}`);
    }
  }

  async handleStream(method: string, data: Uint8Array, emit: (data: Uint8Array) => Promise<void>): Promise<void> {
    const decoder = new TextDecoder();
    const encoder = new TextEncoder();
    const rawReq = data.length > 0 ? JSON.parse(decoder.decode(data)) : {};

    const stream = {
      send: async (msg: unknown) => {
        await emit(encoder.encode(JSON.stringify(wrapResponse(msg))));
      },
    };

    switch (method) {
    case 'StreamOutput':
      await this.impl.StreamOutput(extractPayload<StreamOutputRequest>(rawReq), stream);
      break;
    default:
      throw new Error(`Unknown streaming method: ${method}`);
    }
  }
}
