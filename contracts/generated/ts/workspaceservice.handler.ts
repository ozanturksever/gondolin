// Code generated by dink codegen. DO NOT EDIT.

import type { ServiceHandler, ServiceDefinition } from '@fatagnus/dink-sdk';
import { extractPayload, wrapResponse } from '@fatagnus/dink-sdk';
import type { CreateSandboxRequest, CreateSandboxResponse, DestroySandboxRequest, DestroySandboxResponse, GetStatusRequest, GetStatusResponse, ListSandboxesRequest, ListSandboxesResponse } from './types.js';

export interface WorkspaceServiceServer {
  CreateSandbox(req: CreateSandboxRequest): Promise<CreateSandboxResponse>;
  DestroySandbox(req: DestroySandboxRequest): Promise<DestroySandboxResponse>;
  GetStatus(req: GetStatusRequest): Promise<GetStatusResponse>;
  ListSandboxes(req: ListSandboxesRequest): Promise<ListSandboxesResponse>;
}

export class WorkspaceServiceHandler implements ServiceHandler {
  private impl: WorkspaceServiceServer;

  constructor(impl: WorkspaceServiceServer) {
    this.impl = impl;
  }

  definition(): ServiceDefinition {
    return {
      name: 'WorkspaceService',
      version: '1.0.0',
      methods: [
        'CreateSandbox',
        'DestroySandbox',
        'GetStatus',
        'ListSandboxes',
      ],
    };
  }

  async handleRequest(method: string, data: Uint8Array): Promise<Uint8Array> {
    const decoder = new TextDecoder();
    const encoder = new TextEncoder();
    const rawReq = data.length > 0 ? JSON.parse(decoder.decode(data)) : {};

    switch (method) {
    case 'CreateSandbox': {
      const req = extractPayload<CreateSandboxRequest>(rawReq);
      const resp = await this.impl.CreateSandbox(req);
      return encoder.encode(JSON.stringify(wrapResponse(resp)));
    }
    case 'DestroySandbox': {
      const req = extractPayload<DestroySandboxRequest>(rawReq);
      const resp = await this.impl.DestroySandbox(req);
      return encoder.encode(JSON.stringify(wrapResponse(resp)));
    }
    case 'GetStatus': {
      const req = extractPayload<GetStatusRequest>(rawReq);
      const resp = await this.impl.GetStatus(req);
      return encoder.encode(JSON.stringify(wrapResponse(resp)));
    }
    case 'ListSandboxes': {
      const req = extractPayload<ListSandboxesRequest>(rawReq);
      const resp = await this.impl.ListSandboxes(req);
      return encoder.encode(JSON.stringify(wrapResponse(resp)));
    }
    default:
      throw new Error(`Unknown method: ${method}`);
    }
  }

  async handleStream(method: string, data: Uint8Array, emit: (data: Uint8Array) => Promise<void>): Promise<void> {
    const decoder = new TextDecoder();
    const encoder = new TextEncoder();
    const rawReq = data.length > 0 ? JSON.parse(decoder.decode(data)) : {};

    const stream = {
      send: async (msg: unknown) => {
        await emit(encoder.encode(JSON.stringify(wrapResponse(msg))));
      },
    };

    switch (method) {
    default:
      throw new Error(`Unknown streaming method: ${method}`);
    }
  }
}
