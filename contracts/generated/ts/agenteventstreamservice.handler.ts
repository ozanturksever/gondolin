// Code generated by dink codegen. DO NOT EDIT.

import type { ServiceHandler, ServiceDefinition } from '@fatagnus/dink-sdk';
import { extractPayload, wrapResponse } from '@fatagnus/dink-sdk';
import type { StreamEventsRequest, StreamEventsResponse } from './types.js';

export interface AgentEventStreamServiceServer {
  StreamEvents(req: StreamEventsRequest, stream: { send: (msg: StreamEventsResponse) => Promise<void> }): Promise<void>;
}

export class AgentEventStreamServiceHandler implements ServiceHandler {
  private impl: AgentEventStreamServiceServer;

  constructor(impl: AgentEventStreamServiceServer) {
    this.impl = impl;
  }

  definition(): ServiceDefinition {
    return {
      name: 'AgentEventStreamService',
      version: '1.0.0',
      methods: [
        'StreamEvents',
      ],
    };
  }

  async handleRequest(method: string, data: Uint8Array): Promise<Uint8Array> {
    const decoder = new TextDecoder();
    const encoder = new TextEncoder();
    const rawReq = data.length > 0 ? JSON.parse(decoder.decode(data)) : {};

    switch (method) {
    default:
      throw new Error(`Unknown method: ${method}`);
    }
  }

  async handleStream(method: string, data: Uint8Array, emit: (data: Uint8Array) => Promise<void>): Promise<void> {
    const decoder = new TextDecoder();
    const encoder = new TextEncoder();
    const rawReq = data.length > 0 ? JSON.parse(decoder.decode(data)) : {};

    const stream = {
      send: async (msg: unknown) => {
        await emit(encoder.encode(JSON.stringify(wrapResponse(msg))));
      },
    };

    switch (method) {
    case 'StreamEvents':
      await this.impl.StreamEvents(extractPayload<StreamEventsRequest>(rawReq), stream);
      break;
    default:
      throw new Error(`Unknown streaming method: ${method}`);
    }
  }
}
